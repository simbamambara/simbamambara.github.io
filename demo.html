<script>
    // Store templates fetched from the backend
    let formTemplates = {};
    let contractTemplates = {};

    // --- CORE FUNCTIONALITY TO CALL THE BACKEND ---

    // Function to populate dropdowns with data from the backend
    async function populateDropdowns() {
        try {
            const response = await fetch('/api/data/dropdowns');
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();

            // Populate years
            const yearSelect = document.getElementById('year-search');
            yearSelect.innerHTML = '<option value="">All Years</option>'; // Reset
            data.years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.innerText = year;
                yearSelect.appendChild(option);
            });

            // Populate subjects
            const subjectSelect = document.getElementById('subject-search');
            subjectSelect.innerHTML = '<option value="">All Subjects</option>'; // Reset
            data.subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.innerText = subject;
                subjectSelect.appendChild(option);
            });
            
            // Populate legislation
            const legislationSelect = document.getElementById('legislation-select');
            legislationSelect.innerHTML = '<option value="">Select Legislation</option>'; // Reset
            data.legislation.forEach(title => {
                if (title) { // Ensure title is not null/empty
                    const option = document.createElement('option');
                    option.value = title;
                    option.innerText = title;
                    legislationSelect.appendChild(option);
                }
            });

        } catch (error) {
            console.error("Failed to fetch dropdown data:", error);
        }
    }
    
    // Function to fetch all drafting templates
    async function fetchTemplates() {
        try {
            const response = await fetch('/api/draft/templates');
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            formTemplates = data.forms;
            contractTemplates = data.contracts;
            
            // Populate form drafter dropdown
            const formSelect = document.getElementById('form-template-select');
            formSelect.innerHTML = '<option value="">Select a form template</option>';
            Object.keys(formTemplates).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                // Capitalize and replace underscores for display
                option.innerText = (key.charAt(0).toUpperCase() + key.slice(1)).replace(/_/g, ' ');
                formSelect.appendChild(option);
            });
            
            // Populate contract drafter dropdown and generate initial fields
            const contractSelect = document.getElementById('contract-type');
            contractSelect.innerHTML = '';
            Object.keys(contractTemplates).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.innerText = contractTemplates[key].template.split('\\n')[0]; // Use first line as name
                contractSelect.appendChild(option);
            });
            generateContractFields(); // Generate fields for the default selection

        } catch (error) {
            console.error("Failed to fetch templates:", error);
        }
    }


    // Tab functionality (no changes needed here)
    const tabs = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.dataset.tab;
            tabs.forEach(t => t.classList.remove('border-blue-500', 'text-gray-800', 'font-semibold'));
            tab.classList.add('border-blue-500', 'text-gray-800', 'font-semibold');
            tabContents.forEach(content => content.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        });
    });

    // Case Law Search - UPDATED to call API
    document.getElementById('search-btn').addEventListener('click', async () => {
        const citation = document.getElementById('citation-search').value;
        const subject = document.getElementById('subject-search').value;
        const country = document.getElementById('country-search').value;
        const year = document.getElementById('year-search').value;

        // Build query string
        const params = new URLSearchParams({ citation, subject, country, year });
        const resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = '<p class="text-gray-500">Searching...</p>';

        try {
            const response = await fetch(`/api/search/case-law?${params.toString()}`);
            if (!response.ok) throw new Error('Search failed');
            const results = await response.json();
            displayResults(results);
        } catch (error) {
            resultsContainer.innerHTML = '<p class="text-red-500">Error fetching search results.</p>';
            console.error("Search failed:", error);
        }
    });
    
    function displayResults(results) {
        const resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = '';
        
        if (results.length === 0) {
            resultsContainer.innerHTML = '<p class="text-gray-500">No results found for your criteria.</p>';
            return;
        }

        const zimResults = results.filter(r => r.country === 'Zimbabwe');
        const foreignResults = results.filter(r => r.country !== 'Zimbabwe');

        if (zimResults.length > 0) {
            resultsContainer.innerHTML += '<h3 class="text-xl font-bold mb-2 text-gray-700">Zimbabwean Judgments</h3>';
            zimResults.forEach(r => resultsContainer.innerHTML += resultCard(r));
        }

        if (foreignResults.length > 0) {
            resultsContainer.innerHTML += '<h3 class="text-xl font-bold mt-6 mb-2 text-gray-700">Foreign Judgments</h3>';
            foreignResults.forEach(r => resultsContainer.innerHTML += resultCard(r));
        }
        
        // Re-attach event listeners for the new "View Judgment" buttons
        document.querySelectorAll('.view-judgment-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const citation = e.target.dataset.citation;
                // Find the full judgment object from the fetched results
                const judgment = results.find(j => j.citation === citation);
                if (judgment) {
                    openModal(judgment);
                }
            });
        });
    }

    function resultCard(r) {
        return `<div class="bg-gray-50 p-4 rounded-lg shadow mb-4">
                    <h4 class="font-bold text-lg">${r.case_name || 'N/A'} (${r.citation || 'N/A'})</h4>
                    <p><strong>Subject:</strong> ${r.subject || 'N/A'}</p>
                    <p><strong>Country:</strong> ${r.country || 'N/A'}</p>
                    <p><strong>Year:</strong> ${r.year || 'N/A'}</p>
                    <button class="view-judgment-btn mt-2 text-blue-600 hover:underline" data-citation="${r.citation}">View Judgment</button>
                </div>`;
    }
    
    // Modal functionality (no changes needed here)
    const modal = document.getElementById('judgment-modal');
    const modalClose = document.getElementById('modal-close');
    
    function openModal(judgment) {
        document.getElementById('modal-title').innerText = `${judgment.case_name || 'N/A'} - ${judgment.citation || 'N/A'}`;
        document.getElementById('modal-body').innerText = judgment.body || 'Full text not available.';
        modal.classList.add('active');
    }

    modalClose.addEventListener('click', () => modal.classList.remove('active'));
    window.addEventListener('click', (e) => {
        if (e.target === modal) modal.classList.remove('active');
    });
    
    // Legislation Search - Simplified, as details are not in the provided data structure
    document.getElementById('legislation-select').addEventListener('change', (e) => {
        const selectedTitle = e.target.value;
        const container = document.getElementById('legislation-results');
        container.innerHTML = '';

        if (selectedTitle) {
            // In a full implementation, you'd fetch details for this specific legislation
            // For now, we just display the title, as that's what the API provides in the list.
            container.innerHTML = `<div class="bg-gray-50 p-4 rounded-lg shadow mb-4">
                                        <h4 class="font-bold text-lg">${selectedTitle}</h4>
                                        <p>Select legislation to view full text or details.</p>
                                   </div>`;
        }
    });
    
    // Form Drafter - UPDATED to use fetched templates
    document.getElementById('form-template-select').addEventListener('change', (e) => {
        const template = formTemplates[e.target.value] || '';
        document.getElementById('form-editor').value = template;
    });

    // Contract Drafter - UPDATED to use fetched templates
    const contractTypeSelect = document.getElementById('contract-type');
    const contractFieldsContainer = document.getElementById('contract-fields');

    function generateContractFields() {
        const contractType = contractTypeSelect.value;
        if (!contractTemplates[contractType]) return; // Guard against empty templates
        const fields = contractTemplates[contractType].fields;
        contractFieldsContainer.innerHTML = '';
        fields.forEach(field => {
            const input = document.createElement('input');
            input.type = field.type || 'text';
            input.id = field.id;
            input.placeholder = field.placeholder;
            input.className = 'w-full p-2 border rounded mb-2';
            contractFieldsContainer.appendChild(input);
        });
    }
    
    contractTypeSelect.addEventListener('change', generateContractFields);

    document.getElementById('generate-contract-btn').addEventListener('click', () => {
        const contractType = contractTypeSelect.value;
        if (!contractTemplates[contractType]) return;
        let contractText = contractTemplates[contractType].template;
        
        contractTemplates[contractType].fields.forEach(field => {
            const value = document.getElementById(field.id).value;
            const regex = new RegExp(`\\[${field.placeholder}\\]`, 'g');
            contractText = contractText.replace(regex, value || `[${field.placeholder}]`);
        });
        
        document.getElementById('contract-output').value = contractText;
    });
    
    // Clipboard functionality (no changes needed here)
    function copyToClipboard(text, btn) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            const originalText = btn.innerText;
            btn.innerText = 'Copied!';
            setTimeout(() => { btn.innerText = originalText; }, 2000);
        }).catch(err => {
            console.error('Failed to copy text: ', err);
        });
    }

    document.getElementById('copy-form-btn').addEventListener('click', (e) => {
        const text = document.getElementById('form-editor').value;
        copyToClipboard(text, e.target);
    });

    document.getElementById('copy-contract-btn').addEventListener('click', (e) => {
        const text = document.getElementById('contract-output').value;
        copyToClipboard(text, e.target);
    });

    // Initial setup - Call the new async functions
    document.addEventListener('DOMContentLoaded', () => {
        populateDropdowns();
        fetchTemplates();
    });
</script>
